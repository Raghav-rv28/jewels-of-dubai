{% comment %}
  Newsletter Parallax Section
  
  A cinematic newsletter signup section with parallax background effect.
  Features elegant form design with validation and success messaging.
{% endcomment %}

{% liquid
  assign section_id = section.settings.custom_id | default: section.id
  assign heading = section.settings.heading
  assign subheading = section.settings.subheading
  assign enable_parallax = section.settings.enable_parallax
  assign parallax_speed = section.settings.parallax_speed
%}

<section 
  id="{{ section_id }}" 
  class="newsletter-parallax section"
  style="
    --section-height: {{ section.settings.section_height }}px;
  "
>
  <div class="newsletter-parallax__background">
    {% if enable_parallax %}
      {% if section.settings.video_url != blank %}
        {% render 'parallax-container',
          video: section.settings.video_url,
          speed: parallax_speed,
          height: section.settings.section_height | append: 'px',
          overlay_opacity: section.settings.overlay_opacity,
          container_class: 'newsletter-parallax__container'
        %}
      {% elsif section.settings.background_image != blank %}
        {% render 'parallax-container',
          image: section.settings.background_image,
          speed: parallax_speed,
          height: section.settings.section_height | append: 'px',
          overlay_opacity: section.settings.overlay_opacity,
          container_class: 'newsletter-parallax__container'
        %}
      {% else %}
        <div class="newsletter-parallax__placeholder">
          {{ 'lifestyle-2' | placeholder_svg_tag: 'newsletter-parallax__placeholder-svg' }}
        </div>
      {% endif %}
    {% else %}
      {% if section.settings.video_url != blank %}
        <div class="newsletter-parallax__video-wrapper">
          <video 
            class="newsletter-parallax__video"
            autoplay 
            muted 
            loop 
            playsinline
            preload="metadata"
          >
            {%- comment -%}theme-check-disable RemoteAsset{%- endcomment -%}
            <source src="{{ section.settings.video_url }}" type="video/mp4">
            {%- comment -%}theme-check-enable RemoteAsset{%- endcomment -%}
          </video>
          <div class="newsletter-parallax__overlay" style="opacity: {{ section.settings.overlay_opacity }};"></div>
        </div>
      {% elsif section.settings.background_image != blank %}
        <div class="newsletter-parallax__image-wrapper">
          {% render 'image',
            image: section.settings.background_image,
            width: 1920,
            height: 1080,
            class: 'newsletter-parallax__image'
          %}
          <div class="newsletter-parallax__overlay" style="opacity: {{ section.settings.overlay_opacity }};"></div>
        </div>
      {% else %}
        <div class="newsletter-parallax__placeholder">
          {{ 'lifestyle-2' | placeholder_svg_tag: 'newsletter-parallax__placeholder-svg' }}
        </div>
      {% endif %}
    {% endif %}
  </div>
  
  <div class="newsletter-parallax__content">
    <div class="newsletter-parallax__inner scroll-reveal scroll-reveal--scale">
      {% if heading != blank %}
        <h2 class="newsletter-parallax__heading">{{ heading | escape }}</h2>
      {% endif %}
      
      {% if subheading != blank %}
        <p class="newsletter-parallax__subheading">{{ subheading | escape }}</p>
      {% endif %}
      
      <div class="newsletter-parallax__form-wrapper">
        {% form 'customer', class: 'newsletter-parallax__form', id: 'newsletter-form' %}
          <input type="hidden" name="contact[tags]" value="newsletter">
          
          <div class="newsletter-parallax__form-group">
            <div class="newsletter-parallax__input-wrapper">
              <input 
                type="email" 
                name="contact[email]" 
                id="newsletter-email"
                class="newsletter-parallax__input"
                placeholder="{{ section.settings.placeholder | escape }}"
                aria-label="Email address"
                required
              >
              <button 
                type="submit" 
                class="newsletter-parallax__button"
                aria-label="Subscribe to newsletter"
              >
                {{ section.settings.button_text | escape }}
                <svg class="newsletter-parallax__button-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M4.16667 10H15.8333M15.8333 10L10 4.16666M15.8333 10L10 15.8333" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>
          
          <div class="newsletter-parallax__message" data-newsletter-message></div>
        {% endform %}
        
        {% if section.settings.show_privacy_notice %}
          <p class="newsletter-parallax__privacy">
            {{ section.settings.privacy_text | default: 'We respect your privacy. Unsubscribe at any time.' }}
          </p>
        {% endif %}
      </div>
    </div>
  </div>
</section>

{% stylesheet %}
  .newsletter-parallax {
    position: relative;
    width: 100%;
    height: var(--section-height, 600px);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  
  .newsletter-parallax__background {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
  }
  
  .newsletter-parallax__video-wrapper,
  .newsletter-parallax__image-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
  }
  
  .newsletter-parallax__video,
  .newsletter-parallax__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }
  
  .newsletter-parallax__overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(
      135deg,
      rgba(0, 0, 0, 0.6) 0%,
      rgba(0, 0, 0, 0.4) 50%,
      rgba(0, 0, 0, 0.6) 100%
    );
    z-index: 1;
  }
  
  .newsletter-parallax__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
  }
  
  .newsletter-parallax__placeholder-svg {
    width: 200px;
    height: 200px;
    opacity: 0.3;
    color: white;
  }
  
  .newsletter-parallax__content {
    position: relative;
    z-index: 2;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-xl);
  }
  
  .newsletter-parallax__inner {
    max-width: 700px;
    width: 100%;
    text-align: center;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border-radius: calc(var(--border-radius, 8px) * 2);
    padding: var(--spacing-3xl);
    box-shadow: var(--shadow-xl);
  }
  
  .newsletter-parallax__heading {
    font-family: var(--font-heading);
    font-size: clamp(2rem, 4vw, 3rem);
    font-weight: 300;
    line-height: 1.2;
    letter-spacing: -0.02em;
    margin: 0 0 var(--spacing-md) 0;
    color: var(--color-foreground, #1F2937);
  }
  
  .newsletter-parallax__subheading {
    font-size: clamp(1rem, 2vw, 1.25rem);
    line-height: 1.6;
    margin: 0 0 var(--spacing-xl) 0;
    color: var(--color-foreground, #1F2937);
    opacity: 0.8;
  }
  
  .newsletter-parallax__form-wrapper {
    margin-top: var(--spacing-xl);
  }
  
  .newsletter-parallax__form-group {
    margin-bottom: var(--spacing-md);
  }
  
  .newsletter-parallax__input-wrapper {
    display: flex;
    gap: 0;
    background: #FFFFFF;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-radius: var(--border-radius, 8px);
    overflow: hidden;
    transition: var(--transition-normal);
  }
  
  .newsletter-parallax__input-wrapper:focus-within {
    border-color: var(--color-primary, #D4AF37);
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
  }
  
  .newsletter-parallax__input {
    flex: 1;
    padding: var(--spacing-md) var(--spacing-lg);
    border: none;
    font-family: var(--font-body);
    font-size: 1rem;
    color: var(--color-foreground, #1F2937);
    background: transparent;
    outline: none;
  }
  
  .newsletter-parallax__input::placeholder {
    color: var(--color-foreground, #1F2937);
    opacity: 0.5;
  }
  
  .newsletter-parallax__button {
    padding: var(--spacing-md) var(--spacing-xl);
    background-color: var(--color-primary, #D4AF37);
    color: white;
    border: none;
    font-family: var(--font-body);
    font-size: 0.9375rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    cursor: pointer;
    transition: var(--transition-normal);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
  }
  
  .newsletter-parallax__button:hover {
    background-color: var(--color-accent, #FFD700);
    transform: translateX(2px);
  }
  
  .newsletter-parallax__button-icon {
    transition: transform var(--transition-fast);
  }
  
  .newsletter-parallax__button:hover .newsletter-parallax__button-icon {
    transform: translateX(4px);
  }
  
  .newsletter-parallax__message {
    margin-top: var(--spacing-md);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--border-radius, 8px);
    font-size: 0.9375rem;
    font-weight: 500;
    opacity: 0;
    transform: translateY(-10px);
    transition: var(--transition-normal);
  }
  
  .newsletter-parallax__message.visible {
    opacity: 1;
    transform: translateY(0);
  }
  
  .newsletter-parallax__message.success {
    background-color: #D4EDDA;
    color: #155724;
    border: 1px solid #C3E6CB;
  }
  
  .newsletter-parallax__message.error {
    background-color: #F8D7DA;
    color: #721C24;
    border: 1px solid #F5C6CB;
  }
  
  .newsletter-parallax__privacy {
    font-size: 0.8125rem;
    color: var(--color-foreground, #1F2937);
    opacity: 0.6;
    margin: var(--spacing-md) 0 0 0;
    line-height: 1.5;
  }
  
  /* Mobile Styles */
  @media (max-width: 767px) {
    .newsletter-parallax {
      height: auto;
      min-height: 500px;
    }
    
    .newsletter-parallax__inner {
      padding: var(--spacing-2xl);
    }
    
    .newsletter-parallax__input-wrapper {
      flex-direction: column;
    }
    
    .newsletter-parallax__input {
      padding: var(--spacing-md);
    }
    
    .newsletter-parallax__button {
      width: 100%;
      justify-content: center;
      padding: var(--spacing-md);
    }
  }
{% endstylesheet %}

{% javascript %}
  class NewsletterForm {
    constructor(form) {
      this.form = form;
      this.messageEl = form.querySelector('[data-newsletter-message]');
      this.init();
    }
    
    init() {
      this.form.addEventListener('submit', this.handleSubmit.bind(this));
    }
    
    async handleSubmit(e) {
      e.preventDefault();
      
      const formData = new FormData(this.form);
      const email = formData.get('contact[email]');
      
      if (!this.validateEmail(email)) {
        this.showMessage('Please enter a valid email address.', 'error');
        return;
      }
      
      try {
        const response = await fetch(this.form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'Accept': 'application/json'
          }
        });
        
        if (response.ok) {
          this.showMessage('Thank you for subscribing! Check your email to confirm.', 'success');
          this.form.reset();
        } else {
          this.showMessage('Something went wrong. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Newsletter signup error:', error);
        this.showMessage('Unable to subscribe. Please try again later.', 'error');
      }
    }
    
    validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }
    
    showMessage(message, type) {
      if (!this.messageEl) return;
      
      this.messageEl.textContent = message;
      this.messageEl.className = `newsletter-parallax__message ${type} visible`;
      
      setTimeout(() => {
        this.messageEl.classList.remove('visible');
      }, 5000);
    }
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('#newsletter-form');
    if (form) {
      new NewsletterForm(form);
    }
  });
  
  document.addEventListener('shopify:section:load', function() {
    const form = document.querySelector('#newsletter-form');
    if (form) {
      new NewsletterForm(form);
    }
  });
{% endjavascript %}

{% render 'scroll-animations' %}

{% schema %}
{
  "name": "Newsletter parallax",
  "tag": "section",
  "class": "newsletter-parallax-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Stay connected"
    },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "Subheading",
      "default": "Subscribe for exclusive offers and new arrivals"
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "Email placeholder",
      "default": "Enter your email"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "Subscribe"
    },
    {
      "type": "header",
      "content": "Background"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background image"
    },
    {
      "type": "url",
      "id": "video_url",
      "label": "Video URL",
      "info": "External video URL (e.g., http://example.com/video.mp4). Overrides image if provided."
    },
    {
      "type": "checkbox",
      "id": "enable_parallax",
      "label": "Enable parallax effect",
      "default": true,
      "info": "Creates a cinematic scrolling effect. Disabled on mobile for performance."
    },
    {
      "type": "range",
      "id": "parallax_speed",
      "label": "Parallax speed",
      "min": 0.1,
      "max": 1,
      "step": 0.1,
      "default": 0.5
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Background overlay opacity",
      "min": 0,
      "max": 1,
      "step": 0.1,
      "default": 0.6
    },
    {
      "type": "range",
      "id": "section_height",
      "label": "Section height",
      "min": 400,
      "max": 900,
      "step": 50,
      "unit": "px",
      "default": 600
    },
    {
      "type": "header",
      "content": "Privacy"
    },
    {
      "type": "checkbox",
      "id": "show_privacy_notice",
      "label": "Show privacy notice",
      "default": true
    },
    {
      "type": "textarea",
      "id": "privacy_text",
      "label": "Privacy notice text",
      "default": "We respect your privacy. Unsubscribe at any time."
    },
    {
      "type": "text",
      "id": "custom_id",
      "label": "Custom section ID"
    }
  ],
  "presets": [
    {
      "name": "Newsletter parallax",
      "settings": {
        "heading": "Stay connected",
        "subheading": "Subscribe for exclusive offers and new arrivals",
        "button_text": "Subscribe",
        "enable_parallax": true
      }
    }
  ]
}
{% endschema %}

